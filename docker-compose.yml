version: '3.8'

services:
  mysqldb:
    image: mysql:8.0
    container_name: vietsneaker-db
    restart: always
    environment:
      MYSQL_DATABASE: vietsneaker
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      # Tạo user riêng cho app (bảo mật hơn dùng root)
      MYSQL_USER: ${DB_USERNAME}
      MYSQL_PASSWORD: ${DB_PASSWORD}
    command: --default-authentication-plugin=mysql_native_password
    volumes:
      - db_data:/var/lib/mysql
    networks:
      - vietsneaker-net
    healthcheck:
      test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  # ----------------------------
  # 2. BACKEND (Spring Boot HTTPS)
  # ----------------------------
  vietsneaker-server:
    # Sửa vuthanhdat04 thành duvnguyen (tên github của bạn)
    image: ghcr.io/duvnguyen/vietsneaker/vietsneaker-server:latest
    container_name: vietsneaker-server
    ports:
      - "8083:8083"
    restart: unless-stopped
    depends_on:
      mysqldb:
        condition: service_healthy
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      # Cấu hình HTTPS
      - SERVER_PORT=8083
      - SERVER_SSL_ENABLED=true
      - SERVER_SSL_KEY_STORE=${SERVER_SSL_KEY_STORE}
      - SERVER_SSL_KEY_STORE_PASSWORD=${SERVER_SSL_KEY_STORE_PASSWORD}
      - SERVER_SSL_KEY_STORE_TYPE=${SERVER_SSL_KEY_STORE_TYPE}
      # Kết nối DB (Dùng tên service 'mysqldb' thay vì localhost)
      - DB_HOST=mysqldb
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      # Các key khác từ file .env
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - JWT_SECRET=${JWT_SECRET}
      - MAIL_USERNAME=${MAIL_USERNAME}
      - MAIL_PASSWORD=${MAIL_PASSWORD}
      # CORS: Cho phép Frontend gọi vào
      - APP_ALLOWED_ORIGINS=${APP_ALLOWED_ORIGINS}
      - APP_BASE_URL=${APP_BASE_URL}
      #Cloud dinary lưu ảnh
      - CLOUDINARY_CLOUD_NAME=${CLOUDINARY_CLOUD_NAME}
      - CLOUDINARY_API_KEY=${CLOUDINARY_API_KEY}
      - CLOUDINARY_API_SECRET=${CLOUDINARY_API_SECRET}
    networks:
      - vietsneaker-net

  # ----------------------------
  # 3. FRONTEND (Next.js)
  # ----------------------------
  vietsneaker-ui:
    # Build từ thư mục hiện tại (chứa Dockerfile bạn gửi)
    # Sửa vuthanhdat04 thành duvnguyen
    image: ghcr.io/duvnguyen/vietsneaker/vietsneaker-ui:latest
    container_name: vietsneaker-ui
    ports:
      - "3000:3000"
    restart: always
    depends_on:
      - vietsneaker-server
    environment:
      - BACKEND_URL=https://vietsneaker-server:8083 # Gọi nội bộ qua Docker Network cho nhanh
      - NODE_TLS_REJECT_UNAUTHORIZED=0
    networks:
      - vietsneaker-net

# Volume để lưu dữ liệu DB bền vững
volumes:
  db_data:

networks:
  vietsneaker-net:
    driver: bridge