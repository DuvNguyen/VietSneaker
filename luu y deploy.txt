M·ª§C TI√äU CU·ªêI

Ng∆∞·ªùi d√πng truy c·∫≠p: http://4.241.131.190

Kh√¥ng hi·ªán port

Kh√¥ng l·ªói SSL tr√™n tr√¨nh duy·ªát

Backend Spring Boot ch·∫°y HTTPS t·ª± k√Ω (n·ªôi b·ªô)

Nginx l√†m reverse proxy

Docker ch·ªâ ch·∫°y image, kh√¥ng c·∫ßn source code

T·ªîNG QUAN KI·∫æN TR√öC (ƒë·ªÉ b·∫°n ki·ªÉm so√°t ƒë∆∞·ª£c)
Internet
   |
   | HTTP :80
   v
Nginx (host OS)
   |
   | HTTP :3000 (internal)
   v
Next.js container
   |
   | HTTP /api/*
   v
Nginx
   |
   | HTTPS :8083 (self-signed)
   v
Spring Boot container

B∆Ø·ªöC 0 ‚Äì Chu·∫©n b·ªã VM

Gi·∫£ s·ª≠:

Ubuntu 20.04 / 22.04

IP: 4.241.131.190

ƒê√£ SSH ƒë∆∞·ª£c v√†o m√°y

ssh ubuntu@4.241.131.190

B∆Ø·ªöC 1 ‚Äì C√†i Docker (B·∫ÆT BU·ªòC)
1.1 Update h·ªá th·ªëng
sudo apt update && sudo apt upgrade -y

1.2 C√†i Docker
sudo apt install -y docker.io

1.3 Enable Docker
sudo systemctl start docker
sudo systemctl enable docker

1.4 Cho user ch·∫°y docker kh√¥ng c·∫ßn sudo
sudo usermod -aG docker ubuntu
newgrp docker


Ki·ªÉm tra:

docker --version

B∆Ø·ªöC 2 ‚Äì C√†i Docker Compose (plugin m·ªõi)
sudo apt install -y docker-compose-plugin


Ki·ªÉm tra:

docker compose version


‚ö†Ô∏è L∆∞u √Ω: d√πng docker compose (kh√¥ng c√≥ d·∫•u -)

B∆Ø·ªöC 3 ‚Äì C√†i Nginx tr√™n HOST (KH√îNG trong Docker)
sudo apt install -y nginx
sudo systemctl start nginx
sudo systemctl enable nginx


Ki·ªÉm tra:

curl http://localhost

B∆Ø·ªöC 4 ‚Äì C·∫•u h√¨nh NGINX (QUAN TR·ªåNG NH·∫§T)
4.1 X√≥a config m·∫∑c ƒë·ªãnh
sudo rm /etc/nginx/sites-enabled/default

4.2 T·∫°o config m·ªõi
sudo nano /etc/nginx/sites-available/vietsneaker

4.3 D√°n Y NGUY√äN n·ªôi dung sau
server {
    listen 80;
    server_name 4.241.131.190;

    # FRONTEND (Next.js)
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # BACKEND (Spring Boot HTTPS t·ª± k√Ω)
    location /api/ {
        proxy_pass https://localhost:8083/api/;
        proxy_ssl_verify off;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto http;
    }
}

4.4 Enable site
sudo ln -s /etc/nginx/sites-available/vietsneaker /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx

B∆Ø·ªöC 5 ‚Äì T·∫°o docker-compose.yml (CH·ªà D√ôNG IMAGE)

T·∫°o th∆∞ m·ª•c l√†m vi·ªác:

mkdir ~/vietsneaker && cd ~/vietsneaker


T·∫°o file:

nano docker-compose.yml

N·ªôi dung docker-compose.yml (M·∫™U CHU·∫®N)

‚ö†Ô∏è B·∫°n ch·ªâ c·∫ßn thay t√™n image cho ƒë√∫ng v·ªõi image b·∫°n ƒëang c√≥

version: "3.8"

services:
  vietsneaker-server:
    image: your-dockerhub/vietsneaker-backend:latest
    container_name: vietsneaker-server
    ports:
      - "127.0.0.1:8083:8083"
    restart: always

  vietsneaker-ui:
    image: your-dockerhub/vietsneaker-frontend:latest
    container_name: vietsneaker-ui
    ports:
      - "127.0.0.1:3000:3000"
    environment:
      - BACKEND_URL=http://4.241.131.190
      - NODE_TLS_REJECT_UNAUTHORIZED=0
    restart: always


üìå Gi·∫£i th√≠ch quan tr·ªçng

127.0.0.1:xxxx ‚Üí ch·ªâ Nginx g·ªçi ƒë∆∞·ª£c

Internet kh√¥ng scan ƒë∆∞·ª£c port

ƒê√∫ng chu·∫©n production

B∆Ø·ªöC 6 ‚Äì Pull image & ch·∫°y
docker compose pull
docker compose up -d


Ki·ªÉm tra:

docker ps

B∆Ø·ªöC 7 ‚Äì TEST
7.1 Test n·ªôi b·ªô
curl http://localhost
curl http://localhost/api/health

7.2 Test t·ª´ tr√¨nh duy·ªát

üëâ M·ªü:

http://4.241.131.190

K·∫æT QU·∫¢ CU·ªêI (CHU·∫®N OPS)

‚úÖ Kh√¥ng l·ªói SSL
‚úÖ Kh√¥ng l·ªô port
‚úÖ Kh√¥ng c·∫ßn domain
‚úÖ Kh√¥ng c·∫ßn cert x·ªãn
‚úÖ Kh√¥ng c·∫ßn source code
‚úÖ ƒê√∫ng m√¥ h√¨nh Reverse Proxy chu·∫©n

Khi n√†o c·∫ßn HTTPS th·∫≠t?

üëâ Ch·ªâ c·∫ßn:

Mua domain

Tr·ªè domain v·ªÅ IP

Ch·∫°y:

sudo certbot --nginx -d tenmien.com


Kh√¥ng ƒë·ªông t·ªõi Docker, kh√¥ng rebuild g√¨ h·∫øt.

N·∫øu b·∫°n mu·ªën:

M√¨nh review image backend c√≥ b·∫≠t HTTPS ƒë√∫ng ch∆∞a

Check l·ªói 502 Bad Gateway

Debug SSLHandshakeException

Harden security (rate limit, headers)

üëâ C·ª© paste log ra, m√¨nh x·ª≠ l√Ω ti·∫øp cho b·∫°n




import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  eslint: {
    // Cho ph√©p build production d√π c√≥ l·ªói eslint
    ignoreDuringBuilds: true,
  },

  // D√πng standalone cho Docker
  output: "standalone",

  // üî• REWRITE API ‚Üí BACKEND CONTAINER
  async rewrites() {
    const backendUrl = process.env.BACKEND_URL || "https://4.241.131.190";
    return [
      {
        source: "/api/:path*",
        destination: `${backendUrl}/api/:path*`,
      },
    ];
  },
};

export default nextConfig;


// src/config/app-config.ts

// ‚ùå KH√îNG d√πng HOST n·ªØa
// Browser ch·ªâ g·ªçi relative path

export const CONTEXT_API = "/api";
export const API_BASE = CONTEXT_API;

export const USERNAME_COOKIE_KEY = "user";
export const ROLES_COOKIE_KEY = "roles";
export const UNIT = 1000000;


SPRING_PROFILES_ACTIVE=prod
# C·∫•u h√¨nh HTTPS
SERVER_PORT=8083
SERVER_SSL_ENABLED=true
SERVER_SSL_KEY_STORE=classpath:keystore/vietsneaker-localhost-new.p12
SERVER_SSL_KEY_STORE_PASSWORD=changeit
SERVER_SSL_KEY_STORE_TYPE=PKCS12
# K·∫øt n·ªëi DB
DBMS_HOST=mysqldb
DB_PORT=3306
DB_USERNAME=admin
DB_PASSWORD=example_123

#C√°c key
SHOP_BASE_URL=https://4.241.131.190
JWT_SECRET=X8s7BPFUGSrDDiPvcxQMpOtXz8W14DV9IvEInh7l1dhtw
OPENAI_API_URL=https://openrouter.ai/api/v1
#MAIL
MAIL_HOST=smtp.gmail.com
MAIL_PORT=587
